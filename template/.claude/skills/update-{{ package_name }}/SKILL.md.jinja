---
name: update-{{ package_name }}
description: Update {{ native_library_name }} native library version. Use when checking for updates, upgrading {{ native_library_name }}, bumping version, or updating native dependencies.
---

# Update {{ native_library_name }} Version

Guide for updating the {{ native_library_name }} native library version in this project.

## Review Automated PR (Most Common)

When the CI creates an automated PR for {{ native_library_name }} update, follow these steps:

### Step 1: Analyze Release Notes

```bash
# Fetch and read release notes
gh api repos/{{ native_repo }}/releases/tags/vX.Y.Z --jq '.body'
```

Look for:
- **Breaking changes** (API removals, signature changes)
- **New features** (new APIs exposed)
- **Security fixes**

### Step 2: Check Why Codegen Failed (if applicable)

```bash
# Check if Rust code compiles
make rust-check
```

Common issues:
- **Removed traits** (e.g., `Ord` for `PublicKey`)
- **Changed function signatures**
- **Renamed types**

### Step 3: Fix Rust Code (if needed)

If `make rust-check` fails, fix the errors in `rust/src/api/`:
- Update code to match new {{ native_library_name }} API
- Add workarounds for removed functionality

### Step 4: Regenerate FRB Bindings

```bash
make codegen
```

### Step 5: Run Tests

```bash
make test
```

### Step 6: Run Analysis

```bash
make analyze
```

### Step 7: Update CHANGELOG.md

Verify AI-generated entry is accurate. Update if needed:
- Fix incorrect descriptions
- Add details about breaking changes and workarounds
- Ensure `{{ crate_name }}` version is mentioned in Highlights

### Step 8: Bump {{ crate_name }} Version

Edit `rust/Cargo.toml`:
```toml
version = "X.Y.Z"  # Bump patch for deps, minor for new features
```

Update CHANGELOG.md Highlights:
```markdown
- **{{ native_library_name }} vX.Y.Z** — description
- **{{ crate_name }} vX.Y.Z** — Rust FFI bindings
```

### Step 9: Sync Cargo.lock

```bash
make rust-check
```

### Step 10: Commit Changes

```bash
git add rust/Cargo.toml rust/Cargo.lock rust/src/api/ lib/src/rust/ CHANGELOG.md
git commit -m "fix: adapt for {{ native_library_name }} vX.Y.Z breaking changes"
```

### Checklist Summary

- [ ] Read release notes for breaking changes
- [ ] Fix Rust compilation errors (if any)
- [ ] `make codegen` — regenerate FRB bindings
- [ ] `make test` — all tests pass
- [ ] `make analyze` — no issues
- [ ] CHANGELOG.md — accurate description
- [ ] `rust/Cargo.toml` — bump `{{ crate_name }}` version
- [ ] `make rust-check` — sync Cargo.lock
- [ ] Commit all changes

---

## Quick Update (Automatic)

```bash
# Check for updates
make check-new-{{ package_name }}-version

# Check and apply updates automatically
make check-new-{{ package_name }}-version ARGS="--update"
```

This will:
1. Check GitHub for latest {{ native_library_name }} release
2. Update `rust/Cargo.toml` with new {{ native_library_name }} dependency tags
3. Show next steps for completing the update

## Manual Update Process

### Step 1: Check Current Version

Check `rust/Cargo.toml`:
```toml
[dependencies]
{% if upstream_crates %}{{ upstream_crates.split(',')[0] | trim }} = { git = "https://github.com/{{ native_repo }}", tag = "{{ upstream_version }}" }{% else %}# upstream crates with tags{% endif %}
```

### Step 2: Update Version

Edit `rust/Cargo.toml` and update the tag for upstream crates.

### Step 3: Update Cargo.lock

```bash
make rust-update
```

### Step 4: Regenerate FRB Bindings (if API changed)

```bash
make codegen
```

### Step 5: Run Tests

```bash
make test
```

### Step 6: Commit Changes

```bash
git add rust/Cargo.toml rust/Cargo.lock
git commit -m "chore(deps): update {{ native_library_name }} to vX.Y.Z"
git push
```

## Check Options

```bash
# Just check (no changes)
make check-new-{{ package_name }}-version

# Check and update
make check-new-{{ package_name }}-version ARGS="--update"

# Update to specific version
make check-new-{{ package_name }}-version ARGS="--update --version vX.Y.Z"

# Force update even if versions match
make check-new-{{ package_name }}-version ARGS="--update --force"

# JSON output for CI
make check-new-{{ package_name }}-version ARGS="--json"
```

## Version Locations

Files automatically updated by `make check-new-{{ package_name }}-version ARGS="--update"`:

| File | What | Description |
|------|------|-------------|
| `rust/Cargo.toml` | upstream tags | Native library dependency version |
| `README.md` | Badge | Version badge in header |
| `CLAUDE.md` | Example | Code example in documentation |

Files that need manual update:

| File | What | Description |
|------|------|-------------|
| `rust/Cargo.toml` | `version` | Rust crate version (bump patch for deps update) |
| `rust/Cargo.lock` | Dependencies | Run `make rust-update` after changing Cargo.toml |
| `CHANGELOG.md` | Entry | Document the {{ native_library_name }} version change |

## Breaking Changes to Watch For

### API Changes
- New functions in upstream crate
- Removed functions
- Changed function signatures
- New struct fields

### Behavior Changes
- Protocol version updates
- New cryptographic algorithms
- Changed error types

### Binding Regeneration

After updating, if API changed, run:
```bash
make codegen
```

Then check for:
- Compilation errors in `rust/src/api/` files
- Missing functions that your code depends on
- Changed function signatures

## Troubleshooting

### "No updates available"
- You're already on the latest version
- Check https://github.com/{{ native_repo }}/releases

### "Cargo build failed"
- New {{ native_library_name }} version may have breaking API changes
- Check {{ native_library_name }} release notes
- May need to update Rust wrapper code in `rust/src/api/`

### Tests fail after update
- API may have changed
- Protocol version may have changed
- Review {{ native_library_name }} changelog for breaking changes

## Upstream Resources

- [{{ native_library_name }} Releases](https://github.com/{{ native_repo }}/releases)
- [{{ native_library_name }} Repository](https://github.com/{{ native_repo }})
