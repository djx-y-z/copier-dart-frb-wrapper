# Automatically check for new {{ native_library_name }} releases and create PR to update rust/Cargo.toml
#
# This workflow:
# 1. Runs daily (or manually) to check for new {{ native_library_name }} releases
# 2. Compares with current upstream dependency tag in rust/Cargo.toml
# 3. If newer version found, updates rust/Cargo.toml and creates a PR
# 4. Attempts to update Cargo.lock, regenerate bindings, and update CHANGELOG
# 5. After merge, manual steps may be needed (see PR description)

name: Check {{ package_name }} Updates

on:
  schedule:
    # Run daily at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version is the same'
        required: false
        default: false
        type: boolean
      target_version:
        description: 'Specific version to update to (leave empty for latest)'
        required: false
        default: ''
        type: string

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{"{{"}} vars.APP_ID {{"}}"}}
          private-key: ${{"{{"}} secrets.APP_PRIVATE_KEY {{"}}"}}

      - uses: actions/checkout@v4
        with:
          token: ${{"{{"}} steps.app-token.outputs.token {{"}}"}}

      - name: Setup FVM and Flutter
        uses: ./.github/actions/setup-fvm

      - name: Check for updates
        id: check
        run: |
          # Build arguments
          ARGS="--ci"

          if [ -n "${{"{{"}} inputs.target_version {{"}}"}}" ]; then
            ARGS="$ARGS --version ${{"{{"}} inputs.target_version {{"}}"}}"
          fi

          if [ "${{"{{"}} inputs.force_update {{"}}"}}" = "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: make check-new-{{ package_name }}-version ARGS=\"$ARGS\""
          make check-new-{{ package_name }}-version ARGS="$ARGS" || true

          echo "Check completed. Outputs:"
          cat $GITHUB_OUTPUT || true

      - name: Update Cargo.toml
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Build arguments for update
          ARGS="--update --ci"

          if [ -n "${{"{{"}} inputs.target_version {{"}}"}}" ]; then
            ARGS="$ARGS --version ${{"{{"}} inputs.target_version {{"}}"}}"
          fi

          if [ "${{"{{"}} inputs.force_update {{"}}"}}" = "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: make check-new-{{ package_name }}-version ARGS=\"$ARGS\""
          make check-new-{{ package_name }}-version ARGS="$ARGS"

      # --- Extended automation steps (all non-blocking) ---

      - name: Setup Rust
        if: steps.check.outputs.needs_update == 'true'
        uses: ./.github/actions/setup-rust
{% if enable_protoc %}

      - name: Setup Protoc
        if: steps.check.outputs.needs_update == 'true'
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Update Cargo.lock
        id: cargo-update
        if: steps.check.outputs.needs_update == 'true'
        continue-on-error: true
        run: |
          echo "Updating Cargo.lock..."
          make update
          echo "cargo_update_status=success" >> $GITHUB_OUTPUT

      - name: Regenerate FRB bindings
        id: codegen
        if: steps.check.outputs.needs_update == 'true'
        continue-on-error: true
        run: |
          echo "Regenerating FRB bindings..."
          make codegen
          echo "codegen_status=success" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        id: changelog
        if: steps.check.outputs.needs_update == 'true'
        continue-on-error: true
        env:
          AI_MODELS_TOKEN: ${{"{{"}} secrets.AI_MODELS_TOKEN {{"}}"}}
        run: |
          if [ -z "$AI_MODELS_TOKEN" ]; then
            echo "AI_MODELS_TOKEN not set, skipping changelog update"
            echo "changelog_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Updating CHANGELOG with AI..."
          make update-changelog ARGS="--version ${{"{{"}} steps.check.outputs.latest_version {{"}}"}} --ci"
          echo "changelog_status=success" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{"{{"}} steps.app-token.outputs.token {{"}}"}}
          sign-commits: true
          commit-message: |
            chore(deps): update {{ native_library_name }} to ${{"{{"}} steps.check.outputs.latest_version {{"}}"}}
          title: "Update {{ native_library_name }} to ${{"{{"}} steps.check.outputs.latest_version {{"}}"}}"
          body: |
            ## Automated {{ native_library_name }} Update

            This PR updates the {{ native_library_name }} native library version.

            ### Version Change

            | Component | Old | New |
            |-----------|-----|-----|
            | {{ native_library_name }} | ${{"{{"}} steps.check.outputs.current_version {{"}}"}} | ${{"{{"}} steps.check.outputs.latest_version {{"}}"}} |

            ${{"{{"}} steps.check.outputs.is_prerelease == 'true' && '> **Pre-release**: This is a release candidate. Consider waiting for stable release unless you need specific features.' || '' {{"}}"}}

            ### Release Notes

            See [{{ native_library_name }} ${{"{{"}} steps.check.outputs.latest_version {{"}}"}} release notes](${{"{{"}} steps.check.outputs.release_url {{"}}"}})

            ### Automation Status

            | Step | Status |
            |------|--------|
            | Update Cargo.toml | ✅ Success |
            | Update Cargo.lock | ${{"{{"}} steps.cargo-update.outputs.cargo_update_status == 'success' && '✅ Success' || '⚠️ Failed' {{"}}"}} |
            | Regenerate bindings | ${{"{{"}} steps.codegen.outputs.codegen_status == 'success' && '✅ Success' || '⚠️ Failed' {{"}}"}} |
            | Update CHANGELOG | ${{"{{"}} steps.changelog.outputs.changelog_status == 'success' && '✅ Success' || (steps.changelog.outputs.changelog_status == 'skipped' && '⏭️ Skipped (no AI_MODELS_TOKEN)' || '⚠️ Failed') {{"}}"}} |

            ${{"{{"}} steps.cargo-update.outputs.cargo_update_status != 'success' && '> ⚠️ **Cargo.lock update failed** — run `make update` manually' || '' {{"}}"}}
            ${{"{{"}} steps.codegen.outputs.codegen_status != 'success' && '> ⚠️ **Codegen failed** — run `make codegen` manually' || '' {{"}}"}}
            ${{"{{"}} steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped' && '> ⚠️ **CHANGELOG update failed** — update manually or run `make update-changelog`' || '' {{"}}"}}
            ${{"{{"}} steps.changelog.outputs.changelog_status == 'skipped' && '> ℹ️ **CHANGELOG not updated** — add `AI_MODELS_TOKEN` secret to enable AI changelog generation' || '' {{"}}"}}

            ### Files Updated Automatically

            - `rust/Cargo.toml` — upstream dependency tag
            - `README.md` — version badge
            {% if enable_claude %}- `CLAUDE.md` — example in documentation
            - `.claude/skills/update-{{ package_name }}/SKILL.md` — example in skill
            {% endif %}${{"{{"}} steps.cargo-update.outputs.cargo_update_status == 'success' && '- `rust/Cargo.lock` — updated dependencies' || '' {{"}}"}}
            ${{"{{"}} steps.codegen.outputs.codegen_status == 'success' && '- `lib/src/rust/*.dart` — regenerated FRB bindings' || '' {{"}}"}}
            ${{"{{"}} steps.changelog.outputs.changelog_status == 'success' && '- `CHANGELOG.md` — AI-generated entry' || '' {{"}}"}}

            ### What Happens After Merge

            1. **Automatic build starts**: The `build-{{ package_name }}.yml` workflow will automatically trigger and build native libraries for all platforms.

            2. **Wait for build completion**: Monitor the [Actions](../../actions) page until the build succeeds and a new Release is published.

            ### Before Merge

            ${{"{{"}} (steps.cargo-update.outputs.cargo_update_status == 'success' && steps.codegen.outputs.codegen_status == 'success' && (steps.changelog.outputs.changelog_status == 'success' || steps.changelog.outputs.changelog_status == 'skipped')) && '✅ All automation steps completed. Review the changes and merge when ready.' || 'Complete the following manual steps:' {{"}}"}}

            ${{"{{"}} steps.cargo-update.outputs.cargo_update_status != 'success' && '- [ ] Run `make update` to update Cargo.lock' || '' {{"}}"}}
            ${{"{{"}} steps.codegen.outputs.codegen_status != 'success' && '- [ ] Run `make codegen` to regenerate FRB bindings' || '' {{"}}"}}
            ${{"{{"}} steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped' && '- [ ] Update CHANGELOG.md manually or run `make update-changelog`' || '' {{"}}"}}
            ${{"{{"}} steps.changelog.outputs.changelog_status == 'skipped' && '- [ ] Update CHANGELOG.md manually' || '' {{"}}"}}

            ${{"{{"}} (steps.cargo-update.outputs.cargo_update_status != 'success' || steps.codegen.outputs.codegen_status != 'success' || (steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped')) && '\nAfter completing manual steps:\n```bash\ngit add .\ngit commit -m \"chore: complete automation for ' || '' {{"}}"}}${{"{{"}} (steps.cargo-update.outputs.cargo_update_status != 'success' || steps.codegen.outputs.codegen_status != 'success' || (steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped')) && steps.check.outputs.latest_version || '' {{"}}"}}${{"{{"}} (steps.cargo-update.outputs.cargo_update_status != 'success' || steps.codegen.outputs.codegen_status != 'success' || (steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped')) && '\"\ngit push\n```' || '' {{"}}"}}

            ---
            *This PR was created automatically by the {{ package_name }} update checker.*
          branch: update-{{ package_name }}-${{"{{"}} steps.check.outputs.latest_version {{"}}"}}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{"{{"}} steps.check.outputs.is_prerelease == 'true' && 'pre-release' || '' {{"}}"}}
            ${{"{{"}} steps.cargo-update.outputs.cargo_update_status != 'success' && 'cargo-lock-failed' || '' {{"}}"}}
            ${{"{{"}} steps.codegen.outputs.codegen_status != 'success' && 'codegen-failed' || '' {{"}}"}}
            ${{"{{"}} (steps.changelog.outputs.changelog_status != 'success' && steps.changelog.outputs.changelog_status != 'skipped') && 'changelog-needed' || '' {{"}}"}}

      - name: Summary
        run: |
          if [ "${{"{{"}} steps.check.outputs.needs_update {{"}}"}}" = "true" ]; then
            echo "## Update Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Current {{ native_library_name }} | ${{"{{"}} steps.check.outputs.current_version {{"}}"}} |" >> $GITHUB_STEP_SUMMARY
            echo "| New {{ native_library_name }} | ${{"{{"}} steps.check.outputs.latest_version {{"}}"}} |" >> $GITHUB_STEP_SUMMARY
            echo "| Pre-release | ${{"{{"}} steps.check.outputs.is_prerelease {{"}}"}} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Automation Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Update Cargo.toml | ✅ Success |" >> $GITHUB_STEP_SUMMARY
            CARGO_STATUS="${{"{{"}} steps.cargo-update.outputs.cargo_update_status {{"}}"}}"
            CODEGEN_STATUS="${{"{{"}} steps.codegen.outputs.codegen_status {{"}}"}}"
            CHANGELOG_STATUS="${{"{{"}} steps.changelog.outputs.changelog_status {{"}}"}}"
            echo "| Update Cargo.lock | $( [ \"$CARGO_STATUS\" = \"success\" ] && echo \"✅ Success\" || echo \"⚠️ Failed\" ) |" >> $GITHUB_STEP_SUMMARY
            echo "| Regenerate bindings | $( [ \"$CODEGEN_STATUS\" = \"success\" ] && echo \"✅ Success\" || echo \"⚠️ Failed\" ) |" >> $GITHUB_STEP_SUMMARY
            if [ "$CHANGELOG_STATUS" = "success" ]; then
              echo "| Update CHANGELOG | ✅ Success |" >> $GITHUB_STEP_SUMMARY
            elif [ "$CHANGELOG_STATUS" = "skipped" ]; then
              echo "| Update CHANGELOG | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Update CHANGELOG | ⚠️ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$CARGO_STATUS" != "success" ]; then
              echo "> ⚠️ Cargo.lock update failed — run \`make update\` manually" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$CODEGEN_STATUS" != "success" ]; then
              echo "> ⚠️ Codegen failed — run \`make codegen\` manually" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$CHANGELOG_STATUS" = "skipped" ]; then
              echo "> ℹ️ CHANGELOG not updated — add AI_MODELS_TOKEN secret to enable" >> $GITHUB_STEP_SUMMARY
            elif [ "$CHANGELOG_STATUS" != "success" ]; then
              echo "> ⚠️ CHANGELOG update failed — update manually" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current version **${{"{{"}} steps.check.outputs.current_version {{"}}"}}** is the latest." >> $GITHUB_STEP_SUMMARY
          fi
