# Reusable test workflow for multi-platform testing
#
# Called by:
# - test.yml (on push/PR)
# - publish.yml (before publishing)
#
# Runs tests in parallel on: Linux x86_64, Linux ARM64, macOS ARM64, Windows x86_64
# Coverage: Only collected on Linux x86_64
# Badge: Updated only after ALL platform tests pass

name: Test (Reusable)

on:
  workflow_call:
    inputs:
      run-coverage:
        description: 'Run coverage analysis (Linux x86_64 only)'
        type: boolean
        default: true
      update-badge:
        description: 'Update coverage badge (requires GIST_TOKEN secret)'
        type: boolean
        default: false
    secrets:
      GIST_TOKEN:
        required: false
    outputs:
      coverage-percentage:
        description: 'Coverage percentage (from Linux x86_64 run)'
        value: ${{"{{"}} jobs.test.outputs.coverage {{"}}"}}

jobs:
  # ============================================
  # Security audit for Rust dependencies
  # ============================================
  rust-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit --file rust/Cargo.lock

  # ============================================
  # Multi-platform tests
  # ============================================
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x86_64
            coverage: true
            rust_target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            coverage: false
            rust_target: aarch64-unknown-linux-gnu
          - os: macos-latest
            name: macOS ARM64
            coverage: false
            rust_target: aarch64-apple-darwin
          - os: windows-latest
            name: Windows x86_64
            coverage: false
            rust_target: x86_64-pc-windows-msvc

    name: Test (${{"{{"}} matrix.name {{"}}"}})
    runs-on: ${{"{{"}} matrix.os {{"}}"}}
    outputs:
      coverage: ${{"{{"}} steps.coverage.outputs.percentage {{"}}"}}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Make (Windows)
        uses: ./.github/actions/setup-make

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{"{{"}} matrix.rust_target {{"}}"}}
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Setup FVM and Flutter
        uses: ./.github/actions/setup-fvm

      - name: Get dependencies
        run: make get
        shell: bash

      - name: Build Rust library
        run: make build ARGS="--target ${{"{{"}} matrix.rust_target {{"}}"}}"
        shell: bash

      - name: Analyze
        run: make analyze ARGS="--fatal-infos"
        shell: bash

      - name: Check formatting
        run: make format-check
        shell: bash

      # Run tests without coverage (non-Linux or coverage disabled)
      - name: Run tests
        if: matrix.coverage == false || !inputs.run-coverage
        run: make test
        shell: bash

      # Coverage only on Linux x86_64 when enabled
      - name: Install lcov
        if: matrix.coverage == true && inputs.run-coverage
        run: sudo apt-get install -y lcov
        shell: bash

      - name: Run tests with coverage
        if: matrix.coverage == true && inputs.run-coverage
        run: make coverage
        shell: bash

      - name: Calculate coverage percentage
        if: matrix.coverage == true && inputs.run-coverage
        id: coverage
        run: |
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep 'lines' | sed 's/.*: //' | sed 's/%.*//')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"
        shell: bash

  # ============================================
  # Update coverage badge (after ALL tests pass)
  # ============================================
  update-badge:
    name: Update Coverage Badge
    needs: test
    if: inputs.update-badge && inputs.run-coverage
    runs-on: ubuntu-latest
    steps:
      - name: Validate badge secrets
        run: |
          if [ -z "${{"{{"}} secrets.GIST_TOKEN {{"}}"}}" ]; then
            echo "::error::GIST_TOKEN secret is not configured"
            echo "Please add GIST_TOKEN to your repository secrets."
            echo "See: https://docs.github.com/en/actions/security-guides/encrypted-secrets"
            exit 1
          fi
          if [ -z "${{"{{"}} vars.COVERAGE_GIST_ID {{"}}"}}" ]; then
            echo "::error::COVERAGE_GIST_ID variable is not configured"
            echo "Please add COVERAGE_GIST_ID to your repository variables."
            echo "See: https://docs.github.com/en/actions/learn-github-actions/variables"
            exit 1
          fi
          echo "Badge secrets validated successfully"
        shell: bash

      - name: Update coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{"{{"}} secrets.GIST_TOKEN {{"}}"}}
          gistID: ${{"{{"}} vars.COVERAGE_GIST_ID {{"}}"}}
          filename: coverage.json
          label: coverage
          message: ${{"{{"}} needs.test.outputs.coverage {{"}}"}}%
