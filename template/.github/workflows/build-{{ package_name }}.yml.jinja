# Build {{ package_name }} FRB native libraries for all platforms
#
# This workflow builds Rust code using cargo and creates GitHub Releases
# with pre-built native libraries for all supported platforms.
#
# Platforms:
# - Linux x86_64, arm64 (dynamic .so)
# - macOS arm64, x86_64 (dynamic .dylib)
# - iOS device arm64, simulator arm64/x86_64 (dynamic .dylib)
# - Android arm64-v8a, armeabi-v7a, x86_64 (dynamic .so)
# - Windows x86_64 (dynamic .dll)
{% if enable_web %}
# - Web (WASM)
{% endif %}
#
# Trigger:
# - Manual dispatch (workflow_dispatch) - for first run or force rebuild
# - Push to main when rust/Cargo.toml changes (contains version)
#
# After successful build, creates/updates GitHub Release with native library archives.

name: Build {{ package_name }} FRB Libraries

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'rust/Cargo.toml'
      - 'rust/src/**'

concurrency:
  group: build-{{ crate_name }}-${{"{{"}} github.ref {{"}}"}}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # Check if release already exists (uses scripts/check_exists_frb_release.dart)
  # ============================================
  check-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{"{{"}} steps.check.outputs.version {{"}}"}}
{% if upstream_crate or upstream_crates %}
      {{ package_name }}_version: ${{"{{"}} steps.check.outputs.{{ package_name }}_version {{"}}"}}
{% endif %}
      skip: ${{"{{"}} steps.check.outputs.skip {{"}}"}}
    steps:
      - uses: actions/checkout@v4

      - name: Setup FVM and Flutter
        uses: ./.github/actions/setup-fvm

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{"{{"}} github.token {{"}}"}}
        run: make check-exists-{{ package_name }}-frb-release ARGS="--ci"

  # ============================================
  # Linux (x86_64 + arm64 on separate runners)
  # ============================================
  build-linux:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    strategy:
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
          - arch: arm64
            runner: ubuntu-24.04-arm
            rust_target: aarch64-unknown-linux-gnu
    runs-on: ${{"{{"}} matrix.runner {{"}}"}}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{"{{"}} matrix.rust_target {{"}}"}}
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for Linux ${{"{{"}} matrix.arch {{"}}"}}
        run: |
          cd rust
          cargo build --release --target ${{"{{"}} matrix.rust_target {{"}}"}}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-linux-${{"{{"}} matrix.arch {{"}}"}}
          path: rust/target/${{"{{"}} matrix.rust_target {{"}}"}}/release/lib{{ crate_name }}.so

  # ============================================
  # macOS (arm64 + x86_64 on separate runners)
  # ============================================
  build-macos:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: macos-latest
            rust_target: aarch64-apple-darwin
          - arch: x86_64
            runner: macos-latest
            rust_target: x86_64-apple-darwin
    runs-on: ${{"{{"}} matrix.runner {{"}}"}}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{"{{"}} matrix.rust_target {{"}}"}}
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for macOS ${{"{{"}} matrix.arch {{"}}"}}
        run: |
          cd rust
          cargo build --release --target ${{"{{"}} matrix.rust_target {{"}}"}}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-macos-${{"{{"}} matrix.arch {{"}}"}}
          path: rust/target/${{"{{"}} matrix.rust_target {{"}}"}}/release/lib{{ crate_name }}.dylib

  # ============================================
  # iOS (dynamic .dylib)
  # ============================================
  build-ios:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    strategy:
      matrix:
        include:
          - target: device
            arch: arm64
            runner: macos-latest
            rust_target: aarch64-apple-ios
          - target: simulator
            arch: arm64
            runner: macos-latest
            rust_target: aarch64-apple-ios-sim
          - target: simulator
            arch: x86_64
            runner: macos-latest
            rust_target: x86_64-apple-ios
    runs-on: ${{"{{"}} matrix.runner {{"}}"}}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{"{{"}} matrix.rust_target {{"}}"}}
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for iOS ${{"{{"}} matrix.target {{"}}"}} ${{"{{"}} matrix.arch {{"}}"}}
        run: |
          cd rust
          cargo build --release --target ${{"{{"}} matrix.rust_target {{"}}"}}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-ios-${{"{{"}} matrix.target {{"}}"}}-${{"{{"}} matrix.arch {{"}}"}}
          path: rust/target/${{"{{"}} matrix.rust_target {{"}}"}}/release/lib{{ crate_name }}.dylib

  # ============================================
  # Android (all architectures)
  # ============================================
  build-android:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - abi: arm64-v8a
            rust_target: aarch64-linux-android
          - abi: armeabi-v7a
            rust_target: armv7-linux-androideabi
          - abi: x86_64
            rust_target: x86_64-linux-android
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{"{{"}} matrix.rust_target {{"}}"}}

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;{{ android_ndk_version }}"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/{{ android_ndk_version }}" >> $GITHUB_ENV

      - name: Setup cargo-ndk
        run: cargo install cargo-ndk
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for Android ${{"{{"}} matrix.abi {{"}}"}}
        run: |
          cd rust
          cargo ndk -t ${{"{{"}} matrix.rust_target {{"}}"}} build --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-android-${{"{{"}} matrix.abi {{"}}"}}
          path: rust/target/${{"{{"}} matrix.rust_target {{"}}"}}/release/lib{{ crate_name }}.so

  # ============================================
  # Windows x86_64
  # ============================================
  build-windows:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1.13.0
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for Windows
        shell: pwsh
        run: |
          # Temporarily rename Git's link.exe to prevent it from shadowing MSVC's link.exe
          $gitLink = "C:\Program Files\Git\usr\bin\link.exe"
          $gitLinkBak = "$gitLink.bak"
          if (Test-Path $gitLink) {
            Rename-Item $gitLink $gitLinkBak
          }
          try {
            cargo build --release `
              --manifest-path rust/Cargo.toml `
              --target x86_64-pc-windows-msvc
          } finally {
            if (Test-Path $gitLinkBak) {
              Rename-Item $gitLinkBak $gitLink
            }
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-windows-x86_64
          path: rust/target/x86_64-pc-windows-msvc/release/{{ crate_name }}.dll
{% if enable_web %}

  # ============================================
  # WebAssembly (wasm32)
  # ============================================
  build-wasm:
    needs: check-release
    if: needs.check-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack
{% if enable_protoc %}

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
{% endif %}

      - name: Build for WASM
        run: make build-web

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ package_name }}-wasm32
          path: |
            rust/target/wasm32/{{ crate_name }}.js
            rust/target/wasm32/{{ crate_name }}_bg.wasm
{% endif %}

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    needs:
      - check-release
      - build-linux
      - build-macos
      - build-ios
      - build-android
      - build-windows
{% if enable_web %}
      - build-wasm
{% endif %}
    if: needs.check-release.outputs.skip != 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{"{{"}} needs.check-release.outputs.version {{"}}"}}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release archives
        run: |
          VERSION=${{"{{"}} env.VERSION {{"}}"}}
          mkdir -p release-archives

          # Linux x86_64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-linux-x86_64.tar.gz \
            -C artifacts/{{ package_name }}-linux-x86_64 lib{{ crate_name }}.so

          # Linux arm64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-linux-arm64.tar.gz \
            -C artifacts/{{ package_name }}-linux-arm64 lib{{ crate_name }}.so

          # macOS arm64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-macos-arm64.tar.gz \
            -C artifacts/{{ package_name }}-macos-arm64 lib{{ crate_name }}.dylib

          # macOS x86_64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-macos-x86_64.tar.gz \
            -C artifacts/{{ package_name }}-macos-x86_64 lib{{ crate_name }}.dylib

          # Windows x86_64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-windows-x86_64.tar.gz \
            -C artifacts/{{ package_name }}-windows-x86_64 {{ crate_name }}.dll

          # Android ABIs
          for abi in arm64-v8a armeabi-v7a x86_64; do
            tar -czvf release-archives/{{ crate_name }}-${VERSION}-android-${abi}.tar.gz \
              -C artifacts/{{ package_name }}-android-${abi} lib{{ crate_name }}.so
          done

          # iOS device arm64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-ios-device-arm64.tar.gz \
            -C artifacts/{{ package_name }}-ios-device-arm64 lib{{ crate_name }}.dylib

          # iOS simulator arm64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-ios-simulator-arm64.tar.gz \
            -C artifacts/{{ package_name }}-ios-simulator-arm64 lib{{ crate_name }}.dylib

          # iOS simulator x86_64
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-ios-simulator-x86_64.tar.gz \
            -C artifacts/{{ package_name }}-ios-simulator-x86_64 lib{{ crate_name }}.dylib
{% if enable_web %}

          # WebAssembly
          tar -czvf release-archives/{{ crate_name }}-${VERSION}-wasm32.tar.gz \
            -C artifacts/{{ package_name }}-wasm32 {{ crate_name }}.js {{ crate_name }}_bg.wasm
{% endif %}

          # Generate SHA256 checksums
          cd release-archives
          sha256sum {{ crate_name }}-${VERSION}-*.tar.gz > {{ crate_name }}-${VERSION}-checksums.sha256
          cd ..

          ls -lh release-archives/

      - name: Create Release
        env:
          GH_TOKEN: ${{"{{"}} github.token {{"}}"}}
        run: |
          VERSION=${{"{{"}} env.VERSION {{"}}"}}
          TAG="{{ crate_name }}-${VERSION}"
          TITLE="{{ crate_name }} ${VERSION} - Native Libraries"

          # Delete existing release if it exists (for rebuild scenarios)
          gh release delete "$TAG" --yes 2>/dev/null || true

          # Create release with all assets
          gh release create "$TAG" \
            --title "$TITLE" \
            --latest \
            --notes "$(cat <<'EOF'
          ## {{ crate_name }} ${VERSION} Native Libraries

          Pre-built Flutter Rust Bridge native libraries for all supported platforms.
          **These archives are downloaded automatically by \`hook/build.dart\` during Dart/Flutter builds.**

          ### Platforms

          | Platform | Architecture | Archive |
          |----------|--------------|---------|
          | Linux | x86_64 | \`{{ crate_name }}-${VERSION}-linux-x86_64.tar.gz\` |
          | Linux | arm64 | \`{{ crate_name }}-${VERSION}-linux-arm64.tar.gz\` |
          | macOS | arm64 | \`{{ crate_name }}-${VERSION}-macos-arm64.tar.gz\` |
          | macOS | x86_64 | \`{{ crate_name }}-${VERSION}-macos-x86_64.tar.gz\` |
          | Windows | x86_64 | \`{{ crate_name }}-${VERSION}-windows-x86_64.tar.gz\` |
          | Android | arm64-v8a | \`{{ crate_name }}-${VERSION}-android-arm64-v8a.tar.gz\` |
          | Android | armeabi-v7a | \`{{ crate_name }}-${VERSION}-android-armeabi-v7a.tar.gz\` |
          | Android | x86_64 | \`{{ crate_name }}-${VERSION}-android-x86_64.tar.gz\` |
          | iOS | device (arm64) | \`{{ crate_name }}-${VERSION}-ios-device-arm64.tar.gz\` |
          | iOS | simulator (arm64) | \`{{ crate_name }}-${VERSION}-ios-simulator-arm64.tar.gz\` |
          | iOS | simulator (x86_64) | \`{{ crate_name }}-${VERSION}-ios-simulator-x86_64.tar.gz\` |
{% if enable_web %}
          | Web | wasm32 | \`{{ crate_name }}-${VERSION}-wasm32.tar.gz\` |
{% endif %}

          ### Checksums
          SHA256 checksums are available in \`{{ crate_name }}-${VERSION}-checksums.sha256\`
          EOF
          )" \
            release-archives/{{ crate_name }}-${VERSION}-linux-x86_64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-linux-arm64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-macos-arm64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-macos-x86_64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-windows-x86_64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-android-arm64-v8a.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-android-armeabi-v7a.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-android-x86_64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-ios-device-arm64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-ios-simulator-arm64.tar.gz \
            release-archives/{{ crate_name }}-${VERSION}-ios-simulator-x86_64.tar.gz \
{% if enable_web %}
            release-archives/{{ crate_name }}-${VERSION}-wasm32.tar.gz \
{% endif %}
            release-archives/{{ crate_name }}-${VERSION}-checksums.sha256
