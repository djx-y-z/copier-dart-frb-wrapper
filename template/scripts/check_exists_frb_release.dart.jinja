#!/usr/bin/env dart
/// Check if a FRB release already exists on GitHub.
///
/// Usage:
///   dart run scripts/check_exists_frb_release.dart [--ci]
///
/// Options:
///   --ci  Output in CI-friendly format (GitHub Actions outputs)
///
/// This script checks if the current crate version already has a release.
/// Used by CI to determine if a new build is needed.
///
/// CI Outputs:
///   - version: The crate version from rust/Cargo.toml
{% if upstream_crate or upstream_crates %}
///   - {{ package_name }}_version: The upstream {{ native_library_name }} version
{% endif %}
///   - skip: 'true' if release exists, 'false' otherwise
library;

import 'dart:io';

import 'src/common.dart';

void main(List<String> args) async {
  final isCi = args.contains('--ci');

  final version = getCrateVersion();
{% if upstream_crate or upstream_crates %}
  final upstreamVersion = getUpstreamVersion();
{% endif %}
  final releaseTag = '{{ crate_name }}-$version';

  logInfo('Checking release status...');
  logInfo('Crate version: $version');
{% if upstream_crate or upstream_crates %}
  logInfo('{{ native_library_name }} version: $upstreamVersion');
{% endif %}
  logInfo('Release tag: $releaseTag');

  // Check if release already exists on GitHub
  final releaseExists = await _checkReleaseExists(releaseTag);

  if (isCi) {
    // Output for GitHub Actions
    final outputFile = Platform.environment['GITHUB_OUTPUT'];
    if (outputFile != null) {
      final file = File(outputFile);
      final buffer = StringBuffer();
      buffer.writeln('version=$version');
{% if upstream_crate or upstream_crates %}
      buffer.writeln('{{ package_name }}_version=$upstreamVersion');
{% endif %}
      buffer.writeln('skip=${releaseExists ? 'true' : 'false'}');
      await file.writeAsString(buffer.toString(), mode: FileMode.append);
    }

    if (releaseExists) {
      logWarn('Release $releaseTag already exists. Skipping build.');
    } else {
      logInfo('Release $releaseTag does not exist. Build will proceed.');
    }
  } else {
    if (releaseExists) {
      logWarn('Release $releaseTag already exists on GitHub.');
    } else {
      logInfo('Release $releaseTag does not exist. Ready to build.');
    }
  }
}

Future<bool> _checkReleaseExists(String tag) async {
  final token = Platform.environment['GITHUB_TOKEN'];
  if (token == null || token.isEmpty) {
    logWarn('GITHUB_TOKEN not set. Cannot check release status.');
    return false;
  }

  final client = HttpClient();
  try {
    final url = Uri.parse(
      'https://api.github.com/repos/{{ github_repo }}/releases/tags/$tag',
    );
    final request = await client.getUrl(url);
    request.headers.set('Authorization', 'token $token');
    request.headers.set('Accept', 'application/vnd.github.v3+json');
    request.headers.set('User-Agent', '{{ package_name }}-build-script');

    final response = await request.close();
    await response.drain<void>();
    client.close();

    if (response.statusCode == 200) {
      return true;
    } else if (response.statusCode == 404) {
      return false;
    } else {
      logWarn('Unexpected response from GitHub API: ${response.statusCode}');
      return false;
    }
  } catch (e) {
    logWarn('Failed to check release: $e');
    return false;
  }
}
