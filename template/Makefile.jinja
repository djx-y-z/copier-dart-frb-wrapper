# {{ package_name }} - Makefile
# Cross-platform build and development commands for Flutter Rust Bridge package
#
# Usage: make <target> [ARGS="..."]
# Example: make build ARGS="--target x86_64-unknown-linux-gnu"
# Example: make analyze ARGS="--fatal-infos"
#
# On Windows CI (Git Bash), use cmd to run fvm.bat from PATH:
# Example: make build ARGS="--target x86_64-pc-windows-msvc" FVM="cmd //c fvm"

.PHONY: help setup setup-fvm setup-rust-tools setup-android{% if enable_protoc %} setup-protoc{% endif %}{% if enable_web %} setup-web{% endif %} codegen regen build build-android{% if enable_web %} build-web{% endif %} test coverage analyze format format-check get clean version check-new-{{ package_name }}-version check-exists-{{ package_name }}-frb-release rust-audit rust-check doc publish publish-dry-run combine update update-changelog

# FVM command - can be overridden to provide full path on Windows CI
FVM ?= fvm

# Arguments are passed via ARGS variable
ARGS ?=

# Default target
.DEFAULT_GOAL := help

# =============================================================================
# Help
# =============================================================================

help:
	@echo ""
	@echo "{{ package_name }} - Available commands:"
	@echo ""
	@echo "  Pass arguments via ARGS variable: make <target> ARGS=\"...\""
	@echo ""
	@echo "  SETUP"
	@echo "    make setup                        - Full setup (FVM + Rust tools{% if enable_protoc %} + protoc{% endif %})"
	@echo "    make setup-fvm                    - Install FVM and project Flutter version only"
	@echo "    make setup-rust-tools             - Install Rust tools (cargo-audit, frb codegen)"
	@echo "    make setup-android                - Install Android build tools (cargo-ndk)"
{% if enable_protoc %}
	@echo "    make setup-protoc                 - Install protoc (Protocol Buffers compiler)"
{% endif %}
{% if enable_web %}
	@echo "    make setup-web                    - Install web build tools (wasm-pack)"
{% endif %}
	@echo ""
	@echo "  BUILD & CODEGEN"
	@echo "    make codegen                      - Generate Dart bindings from Rust code"
	@echo "    make regen                        - Alias for codegen"
	@echo "    make build                        - Build Rust library for current platform"
	@echo "                                        Example: make build ARGS=\"--target aarch64-apple-darwin\""
	@echo "    make build-android                - Build for Android (all ABIs)"
	@echo "                                        Example: make build-android ARGS=\"--target arm64-v8a\""
{% if enable_web %}
	@echo "    make build-web                    - Build WASM for web platform"
{% endif %}
	@echo ""
	@echo "  CI / VERSION CHECKS"
	@echo "    make check-new-{{ package_name }}-version  - Check for new upstream {{ native_library_name }} version"
	@echo "                                        Example: make check-new-{{ package_name }}-version ARGS=\"--update\""
	@echo "    make check-exists-{{ package_name }}-frb-release - Check if FRB release exists on GitHub"
	@echo "    make combine                      - Combine CI artifacts (used by GitHub Actions)"
	@echo "    make update                       - Update Cargo.lock (cargo update)"
	@echo "    make update-changelog             - Update CHANGELOG.md with AI"
	@echo "                                        Example: make update-changelog ARGS=\"--version v1.0.0\""
	@echo ""
	@echo "  RUST QUALITY"
	@echo "    make rust-check                   - Check Rust code compiles"
	@echo "    make rust-audit                   - Audit Rust dependencies for vulnerabilities"
	@echo ""
	@echo "  DART QUALITY"
	@echo "    make test                         - Run tests"
	@echo "                                        Example: make test ARGS=\"test/example_test.dart\""
	@echo "    make coverage                     - Run tests with coverage report"
	@echo "    make analyze                      - Run static analysis"
	@echo "                                        Example: make analyze ARGS=\"--fatal-infos\""
	@echo "    make format                       - Format Dart code"
	@echo "    make format-check                 - Check Dart code formatting"
	@echo "    make doc                          - Generate API documentation"
	@echo ""
	@echo "  PUBLISHING"
	@echo "    make publish-dry-run              - Validate package before publishing"
	@echo "    make publish                      - Publish package (CI only, blocked locally)"
	@echo ""
	@echo "  UTILITIES"
	@echo "    make get                          - Get dependencies"
	@echo "    make clean                        - Clean build artifacts"
	@echo "    make version                      - Show current crate version"
	@echo "    make help                         - Show this help message"
	@echo ""

# =============================================================================
# Setup
# =============================================================================

setup:
	@if ! command -v cargo >/dev/null 2>&1; then \
		echo "ERROR: Rust not found. Install from https://rustup.rs"; \
		exit 1; \
	fi
	@$(MAKE) setup-fvm
{% if enable_protoc %}
	@$(MAKE) setup-protoc
{% endif %}
	@$(MAKE) setup-rust-tools
	@echo ""
	@echo "Full setup complete! You can now use 'make help' to see available commands."

setup-fvm:
	@echo "Installing FVM (Flutter Version Management)..."
	dart pub global activate fvm
	@echo ""
	@echo "Installing project Flutter version..."
	$(FVM) install
	@echo ""
	@echo "Getting dependencies..."
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart pub get --no-example; ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret
	@echo ""
	@echo "Configuring git hooks..."
	git config core.hooksPath .githooks
	@echo ""
	@echo "FVM setup complete!"

setup-rust-tools:
	@echo "Installing Rust tools..."
	@if ! command -v cargo-audit >/dev/null 2>&1; then \
		echo "Installing cargo-audit..."; \
		cargo install cargo-audit; \
	else \
		echo "cargo-audit already installed"; \
	fi
	@if ! command -v flutter_rust_bridge_codegen >/dev/null 2>&1; then \
		echo "Installing flutter_rust_bridge_codegen..."; \
		cargo install flutter_rust_bridge_codegen; \
	else \
		echo "flutter_rust_bridge_codegen already installed"; \
	fi
	@echo ""
	@echo "Rust tools setup complete!"

setup-android:
	@echo "Installing Android build tools..."
	@if ! command -v cargo-ndk >/dev/null 2>&1; then \
		echo "Installing cargo-ndk..."; \
		cargo install cargo-ndk; \
	else \
		echo "cargo-ndk already installed"; \
	fi
	@echo ""
	@echo "Android setup complete!"
	@echo "Make sure you have Android NDK installed via Android Studio or sdkmanager."

{% if enable_protoc %}
# Detect OS for platform-specific commands
UNAME_S := $(shell uname -s)

setup-protoc:
	@echo "Setting up protoc (Protocol Buffers compiler)..."
	@if command -v protoc >/dev/null 2>&1; then \
		echo "protoc already installed: $$(protoc --version)"; \
	else \
		echo "Installing protoc..."; \
		if [ "$(UNAME_S)" = "Darwin" ]; then \
			if command -v brew >/dev/null 2>&1; then \
				brew install protobuf; \
			else \
				echo "ERROR: Homebrew not found. Please install protoc manually:"; \
				echo "  brew install protobuf"; \
				exit 1; \
			fi; \
		elif [ "$(UNAME_S)" = "Linux" ]; then \
			if command -v apt-get >/dev/null 2>&1; then \
				sudo apt-get update && sudo apt-get install -y protobuf-compiler; \
			elif command -v dnf >/dev/null 2>&1; then \
				sudo dnf install -y protobuf-compiler; \
			elif command -v pacman >/dev/null 2>&1; then \
				sudo pacman -S --noconfirm protobuf; \
			else \
				echo "ERROR: Could not detect package manager."; \
				echo "Please install protoc manually for your distribution."; \
				exit 1; \
			fi; \
		else \
			echo "ERROR: Unsupported OS for automatic protoc installation."; \
			echo "Please install protoc manually:"; \
			echo "  Windows: choco install protoc"; \
			echo "  Or download from: https://github.com/protocolbuffers/protobuf/releases"; \
			exit 1; \
		fi; \
	fi
	@echo "protoc setup complete!"

{% endif %}
{% if enable_web %}
setup-web:
	@echo "Installing web build tools..."
	@if ! command -v wasm-pack >/dev/null 2>&1; then \
		echo "Installing wasm-pack..."; \
		cargo install wasm-pack; \
	else \
		echo "wasm-pack already installed"; \
	fi
	rustup target add wasm32-unknown-unknown
	@echo ""
	@echo "Web setup complete!"

{% endif %}
# =============================================================================
# Code Generation
# =============================================================================

codegen:
	@touch .skip_{{ package_name }}_hook
	@flutter_rust_bridge_codegen generate $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

# Alias for codegen (common shorthand)
regen: codegen

# =============================================================================
# Build
# =============================================================================

build:
	cargo build --release --manifest-path rust/Cargo.toml $(ARGS)

build-android:
	@echo "Building for Android..."
	@touch .skip_{{ package_name }}_hook
	@cd rust && cargo ndk --platform {{ android_min_sdk }} build --release $(ARGS); ret=$$?; rm -f ../.skip_{{ package_name }}_hook; exit $$ret

{% if enable_web %}
build-web:
	@echo "Building WASM for web..."
	@touch .skip_{{ package_name }}_hook
	@cd rust && wasm-pack build --target no-modules --release \
		--out-dir target/wasm32 --out-name {{ crate_name }} --no-typescript; \
		ret=$$?; \
		rm -f target/wasm32/.gitignore target/wasm32/package.json; \
		rm -f ../.skip_{{ package_name }}_hook; \
		exit $$ret

{% endif %}
# =============================================================================
# Rust Quality
# =============================================================================

rust-check:
	cargo check --manifest-path rust/Cargo.toml

rust-audit:
	cargo audit --file rust/Cargo.lock

# =============================================================================
# CI / Version Checks
# =============================================================================

check-new-{{ package_name }}-version:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/check_new_upstream_version.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

check-exists-{{ package_name }}-frb-release:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/check_exists_frb_release.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

combine:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/combine_artifacts.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

update:
	@echo "Updating Cargo.lock..."
	@cd rust && cargo update
	@echo ""
	@echo "Cargo.lock updated!"

update-changelog:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart run scripts/update_changelog.dart $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

# =============================================================================
# Dart Quality
# =============================================================================

test:
	$(FVM) dart test $(ARGS)

coverage:
	$(FVM) dart test --coverage=coverage
	$(FVM) dart run coverage:format_coverage --check-ignore --lcov --in=coverage --out=coverage/lcov.info --report-on=lib --ignore-files '**/frb_generated*.dart'
	lcov --summary coverage/lcov.info

analyze:
	$(FVM) flutter analyze $(ARGS)

format:
	$(FVM) dart format . $(ARGS)

format-check:
	$(FVM) dart format --set-exit-if-changed . $(ARGS)

doc:
	@touch .skip_{{ package_name }}_hook
	@rm -rf doc; $(FVM) dart doc $(ARGS); ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret
	@echo ""
	@echo "Documentation generated in doc/api/"
	@echo "Open doc/api/index.html to view locally"

# =============================================================================
# Utilities
# =============================================================================

get:
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart pub get --no-example; ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

clean:
	rm -rf .dart_tool build rust/target
	@touch .skip_{{ package_name }}_hook
	@$(FVM) dart pub get --no-example; ret=$$?; rm -f .skip_{{ package_name }}_hook; exit $$ret

version:
	@$(FVM) dart run scripts/get_version.dart

# Internal target for getting version in scripts (outputs only the value)
get-version:
	@$(FVM) dart run scripts/get_version.dart --field version

# =============================================================================
# Publishing
# =============================================================================

publish-dry-run:
	$(FVM) dart pub publish --dry-run

publish:
ifndef CI
	@echo ""
	@echo "ERROR: Local publishing is disabled."
	@echo ""
	@echo "This package uses automated publishing via GitHub Actions."
	@echo "To publish a new version:"
	@echo ""
	@echo "  1. Update version in pubspec.yaml"
	@echo "  2. Update CHANGELOG.md"
	@echo "  3. Commit and push changes"
	@echo "  4. Create and push a tag: git tag v0.1.0 && git push origin v0.1.0"
	@echo "  5. GitHub Actions will automatically publish to pub.dev"
	@echo ""
	@echo "To validate the package locally, use: make publish-dry-run"
	@echo ""
	@exit 1
else
	$(FVM) dart pub publish $(ARGS)
endif
