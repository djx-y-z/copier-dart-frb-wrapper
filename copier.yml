# =============================================================================
# Copier Template: Dart/Flutter FRB (Flutter Rust Bridge) Wrapper
# =============================================================================
# Copier template for creating Dart/Flutter packages that wrap native Rust
# libraries using Flutter Rust Bridge with full CI/CD support.
#
# Usage:
#   mkdir my_package && cd my_package
#   copier copy https://github.com/djx-y-z/copier-dart-frb-wrapper .
#
# Requirements:
#   pip install copier jinja2-strcase
# =============================================================================

_min_copier_version: "9.0.0"
_subdirectory: template
_templates_suffix: .jinja

# Jinja2 extensions for case conversion
_jinja_extensions:
  - jinja2_strcase.StrcaseExtension

# =============================================================================
# Exclude files conditionally
# =============================================================================
_exclude:
  - copier.yml
  - copier.yaml
  - "*.py[co]"
  - __pycache__
  - .git
  - .DS_Store
  - .svn
  - "~*"

# =============================================================================
# VARIABLES
# =============================================================================

# -----------------------------------------------------------------------------
# Required - Package info
# -----------------------------------------------------------------------------
package_name:
  type: str
  help: "Package name (lowercase, no spaces, e.g., my_signal_lib)"
  validator: >-
    {% if not package_name %}
    package_name is required
    {% elif not (package_name | regex_search('^[a-z][a-z0-9_]*$')) %}
    Must be lowercase, start with a letter, contain only letters, numbers, underscores. Got: "{{ package_name }}"
    {% endif %}

description:
  type: str
  help: "Package description for pubspec.yaml"
  validator: "{% if not description %}description is required{% endif %}"

native_library_name:
  type: str
  help: "Name of the native library (e.g., signal_protocol, libsodium)"
  validator: "{% if not native_library_name %}native_library_name is required{% endif %}"

github_repo:
  type: str
  help: "GitHub repository of your wrapper package (username/repo_name)"
  validator: >-
    {% if not github_repo %}
    github_repo is required
    {% elif not (github_repo | regex_search('^[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+$')) %}
    Must be in format "username/repo_name". Got: "{{ github_repo }}"
    {% endif %}

native_repo:
  type: str
  help: "GitHub repository of the native library (username/repo_name, e.g., nickvision/libnick)"
  validator: >-
    {% if not native_repo %}
    native_repo is required
    {% elif not (native_repo | regex_search('^[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+$')) %}
    Must be in format "username/repo_name". Got: "{{ native_repo }}"
    {% endif %}

# -----------------------------------------------------------------------------
# Rust crate configuration
# -----------------------------------------------------------------------------
crate_name:
  type: str
  help: "Rust crate name for the FRB wrapper"
  default: "{{ package_name }}_frb"

rust_edition:
  type: str
  help: "Rust edition"
  choices:
    - "2021"
    - "2024"
  default: "2024"

rust_version:
  type: str
  help: "Minimum Rust version (MSRV)"
  default: "1.88"

# -----------------------------------------------------------------------------
# Flutter Rust Bridge configuration
# -----------------------------------------------------------------------------
frb_version:
  type: str
  help: "Flutter Rust Bridge version constraint"
  default: "^2.11.1"

# -----------------------------------------------------------------------------
# Upstream Rust crates (optional)
# -----------------------------------------------------------------------------
upstream_crates:
  type: str
  help: "Comma-separated list of upstream Rust crates from the same git repo (e.g., 'libsignal-protocol' for single crate, or 'libsignal-protocol,libsignal-core' for multiple). Leave empty if not wrapping an upstream crate."
  default: ""

upstream_version:
  type: str
  help: "Version/tag of the upstream crate (e.g., v1.0.0)"
  default: ""
  when: "{{ upstream_crates != '' }}"

# -----------------------------------------------------------------------------
# Version tag prefix
# -----------------------------------------------------------------------------
version_tag_prefix:
  type: str
  help: "Tag prefix for upstream version tags (e.g., 'v' for tags like v1.0.0, 'release-v' for tags like release-v1.0.0). Used to normalize versions for comparison and prerelease detection."
  default: "v"
  when: "{{ upstream_crates != '' }}"

# -----------------------------------------------------------------------------
# Web/WASM support
# -----------------------------------------------------------------------------
enable_web:
  type: bool
  help: "Enable Web/WASM support"
  default: true

# -----------------------------------------------------------------------------
# Protocol Buffers support (optional)
# -----------------------------------------------------------------------------
enable_protoc:
  type: bool
  help: "Enable Protocol Buffers support (install protoc in setup/CI)"
  default: false

# -----------------------------------------------------------------------------
# Claude Code support
# -----------------------------------------------------------------------------
enable_claude:
  type: bool
  help: "Include Claude Code configuration (CLAUDE.md, .claude/skills/)"
  default: true

# -----------------------------------------------------------------------------
# Flutter/Dart versions
# -----------------------------------------------------------------------------
flutter_version:
  type: str
  help: "Flutter version for FVM"
  default: "3.38.4"

dart_sdk_version:
  type: str
  help: "Dart SDK version constraint"
  default: "^3.10.0"

flutter_sdk_version:
  type: str
  help: "Flutter SDK version constraint"
  default: ">=3.38.0"

# -----------------------------------------------------------------------------
# Android config
# -----------------------------------------------------------------------------
android_min_sdk:
  type: str
  help: "Android minimum SDK version"
  default: "24"

android_compile_sdk:
  type: str
  help: "Android compile SDK version"
  default: "36"

android_ndk_version:
  type: str
  help: "Android NDK version for Rust cross-compilation"
  default: "26.3.11579264"

android_gradle_version:
  type: str
  help: "Android Gradle plugin version"
  default: "8.11.1"

android_java_version:
  type: str
  help: "Java version for Android compilation"
  choices:
    - "11"
    - "17"
    - "21"
  default: "17"

# -----------------------------------------------------------------------------
# License
# -----------------------------------------------------------------------------
license:
  type: str
  help: "Package license"
  choices:
    - MIT
    - AGPL-3.0
    - Apache-2.0
    - BSD-3-Clause
  default: MIT

# -----------------------------------------------------------------------------
# Topics
# -----------------------------------------------------------------------------
topics:
  type: str
  help: "Package topics for pub.dev (comma-separated, max 5, e.g., cryptography,ffi,native)"
  default: "ffi,native,rust"
  validator: "{% if topics.split(',') | map('trim') | select | list | length > 5 %}Maximum 5 topics allowed (pub.dev limit){% endif %}"

# =============================================================================
# POST-GENERATION TASKS
# =============================================================================
_tasks:
  # Initialize git repository
  - command: git init
    working_directory: "{{ _copier_conf.dst_path }}"

  # Create Flutter example app
  # Note: --project-name=example creates applicationId=com.{package_name}.example
  # and Kotlin path com/{package_name}/example/MainActivity.kt
  - command: >-
      flutter create example
      --platforms=android,ios,linux,macos,windows{% if enable_web %},web{% endif %}
      --project-name example
      --org com.{{ package_name }}
    working_directory: "{{ _copier_conf.dst_path }}"

  # Copy template files to example and remove default widget_test.dart
  - command: >-
      cp _templates/example_pubspec.yaml example/pubspec.yaml &&
      cp _templates/example_main.dart example/lib/main.dart &&
      cp _templates/example_gitignore example/.gitignore &&
      cp _templates/example_ios_debug.xcconfig example/ios/Flutter/Debug.xcconfig &&
      cp _templates/example_ios_release.xcconfig example/ios/Flutter/Release.xcconfig &&
      cp _templates/example_macos_debug.xcconfig example/macos/Flutter/Flutter-Debug.xcconfig &&
      cp _templates/example_macos_release.xcconfig example/macos/Flutter/Flutter-Release.xcconfig &&
      cp _templates/example_widget_test.dart example/test/widget_test.dart
    working_directory: "{{ _copier_conf.dst_path }}"

  # Create CLI example app
  - command: dart create -t console example_cli --force
    working_directory: "{{ _copier_conf.dst_path }}"

  # Copy template files to example_cli and cleanup (remove default test and lib)
  - command: >-
      cp _templates/example_cli_pubspec.yaml example_cli/pubspec.yaml &&
      cp _templates/example_cli_main.dart example_cli/bin/main.dart &&
      cp _templates/example_cli_gitignore example_cli/.gitignore &&
      cp _templates/example_cli_analysis_options.yaml example_cli/analysis_options.yaml &&
      rm -f example_cli/bin/example_cli.dart &&
      rm -rf example_cli/test example_cli/lib
    working_directory: "{{ _copier_conf.dst_path }}"

  # Get dependencies for example_cli (after pubspec.yaml replacement)
  - command: dart pub get
    working_directory: "{{ _copier_conf.dst_path }}/example_cli"

  # Remove _templates directory
  - command: rm -rf _templates
    working_directory: "{{ _copier_conf.dst_path }}"

  # Remove Claude files when enable_claude is false
  - command: rm -rf CLAUDE.md .claude
    working_directory: "{{ _copier_conf.dst_path }}"
    when: "{{ not enable_claude }}"

  # Format generated Dart code
  - command: dart format .
    working_directory: "{{ _copier_conf.dst_path }}"

# =============================================================================
# Messages
# =============================================================================
_message_after_copy: |

  FRB wrapper generated successfully!

  Package: {{ package_name }}
  Crate: {{ crate_name }}
  {% if upstream_crates %}Upstream: {{ upstream_crates }} @ {{ upstream_version }}{% endif %}

  Next steps:

  1. Your package is ready at:
     {{ _copier_conf.dst_path }}

  2. Add native library license:
     Copy the license file from the native library to:
     LICENSE_NATIVE or include in LICENSE

  3. Install dependencies and setup:
     make setup

  4. Generate Dart bindings:
     make codegen

  5. Build native libraries:
     make build

  6. Verify everything works:
     make analyze         # Dart static analysis (should be clean)
     make rust-check      # Rust type check
     make test            # Run tests (should pass)

  7. Implement your Rust API in rust/src/api/
     Add your FRB-annotated functions here

  8. Regenerate bindings after Rust changes:
     make codegen

  9. Implement your Dart API in lib/src/

  10. Update example apps in example/ and example_cli/

  11. Write tests in test/ directory
      See test/{{ package_name }}_test.dart for template

  12. Customize package metadata:
      - Update topics in pubspec.yaml if needed
      - Add topics in GitHub repository settings
      - Review and update SECURITY.md with your contact information

  13. Configure GitHub Actions:
      - Create GitHub App for signed commits (APP_ID, APP_PRIVATE_KEY)
      - Setup coverage badge (GIST_TOKEN, COVERAGE_GIST_ID)
      See README.md for detailed instructions

  For more information, see {% if enable_claude %}CLAUDE.md and {% endif %}README.md

_message_after_update: |

  FRB wrapper updated successfully!

  Review the changes and run:
    make setup
    make codegen
    make build
